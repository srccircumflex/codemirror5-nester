<!doctype html>

<title>CodeMirror: Nesting Mode Demo</title>
<meta charset="utf-8"/>
<link rel=stylesheet href="../doc/docs.css">

<link rel="stylesheet" href="../lib/codemirror.css">
<script src="../lib/codemirror.js"></script>

<script src="../mode/xml/xml.js"></script>
<script src="../mode/css/css.js"></script>
<script src="../mode/javascript/javascript.js"></script>
<script src="../mode/htmlmixed/htmlmixed.js"></script>
<script src="../mode/python/python.js"></script>

<script src="../addon/edit/closebrackets.js"></script>
<script src="../addon/edit/matchbrackets.js"></script>

<script src="../addon/hint/show-hint.js"></script>
<link rel="stylesheet" href="../addon/hint/show-hint.css"/>
<script src="../addon/hint/html-hint.js"></script>
<script src="../addon/hint/javascript-hint.js"></script>
<script src="../addon/hint/xml-hint.js"></script>

<script src="../addon/mode/nesting.js"></script>
  
<style>
  .CodeMirror {border: 1px solid black;}
  .cm-delimit {color: #fa4;}
</style>

<style>
  /* MODIFICATIONS > */
  .cm-error {border-bottom: 1px solid red;}
  .CodeMirror {width: 100%; height: 100%;}
  /* < MODIFICATIONS */
  /* EXTENSIONS > */
  .cm-x {color: #ff6391; font-weight: bold;}
  .cm-x-delim1 {color: #ff6391; font-weight: bold;}
  .cm-x-delim2 {color: #ffc863; font-weight: bold;}
  .cm-x-name1 {color: #4e479d; font-weight: bold;}
  .cm-x-name2 {color: #47979d; font-weight: bold;}
  .cm-x-getter {color: rgb(1, 201, 28);}
  .cm-backslash-esc {color: #8c00ff;}
  .cm-lang {color: #0066ff;}
  .cm-lang-bg {background-color: #ffa7000d;}
  /* < EXTENSIONS */
</style>

<div id=nav>
  <a href="https://codemirror.net/5"><h1>CodeMirror</h1><img id=logo src="../doc/logo.png"></a>

  <ul>
    <li><a href="../index.html">Home</a>
    <li><a href="../doc/manual.html">Manual</a>
    <li><a href="https://github.com/codemirror/codemirror5">Code</a>
  </ul>
  <ul>
    <li><a class=active href="#">Nesting Mode</a>
  </ul>
</div>

<article>
  <h2>Nesting Mode Demo</h2>
  <form>

    <label for="code"></label><textarea id="code" name="code">
# NESTING MODE DEMO

$answer$ = 42

for i in $answer.range$[0;]:
  if i % 2 == 0:
    print(i, end = "$\" ")

print(
  f"recursive nesting: {
	# (i) current python versions actually support infinite nesting of 
	# an f string literal with the same quote types, as well as line 
	# breaks and comments in replacement fields.
	$answer$ - 12 * int(f"{9 + $answer$}")}"[0:]
  + html§
<html>
  <body>
    <h1>this is html</h1>
  </body>
</html>
§
)
EOF]</textarea>

  </form>

  <script>
    CodeMirror.defineMode("x", function() {
      return {
        token: function(stream) {
          switch (stream.next()) {
            case "$":
              return "x";
            case "\\":
              stream.next();
              return "backslash-esc";
            case ".":
              return "x-delim1";
            default:
              stream.eatWhile(/[^$\\.]/);
              return "x-name1";
          }
        }
      }
    })

    CodeMirror.defineMode("x[...]", function(config) {
      return {
        token: function(stream) {
          switch (stream.next()) {
            case ";":
              return "x-delim2";
            default:
              stream.eatWhile(/[^;]/);
              return "x-name2";
          }
        }
      }
    })

    var BS_MASK = {
      mask: true,
      open: /\\(.|$)/,
      close: "",
    };

    var COMMENT_MASK = {
      mask: true,
      open: "#",
    };

    var STRING_MASK = {
      mask: true,
      open: /"""|'''|"|'/,
      start: (match) => {return {close: match[0]};},
      masks: [BS_MASK],
    };


    CodeMirror.defineMode("f-string", function(config, parserConfig) {
      return {
        token: function(stream) {
          stream.skipToEnd();
          return "string";
        }
      }
    })

    var FSRING_MODE = CodeMirror.nestingMode(
      CodeMirror.getMode({}, "f-string"),
      {
        mask: true,
        open: /{{|}}/,
        close: "",
      },
      {
        open: "{",
        close: "}",
        mode: "pyx"
      }
    );

    CodeMirror.defineMode("pyx", function(config) {
      return CodeMirror.nestingMode(
        CodeMirror.getMode(config, "text/x-python"),
        STRING_MASK,
        COMMENT_MASK,
        BS_MASK,
        {
          open: /(fr?|rf?)("""|'''|"|')/i,
          start: (match) => {return {close: match[2]}},
          masks: [BS_MASK],
          mode: FSRING_MODE,
          parseDelimiters: true,
        },
        {
          open: /\$(?!\s)/,
          close: "$",
          mode: "x",
          masks: [BS_MASK],
          includeDelimiters: true,
          suffixes: [
            {
              open: /^\[/,
              close: "]",
              mode: "x[...]",
              masks: [BS_MASK],
              delimStyle: "x-getter"
            }
          ]
        },
        {
          open: /(HTML|ML|X)§/i,
          close: "§",
          mode: CodeMirror.getMode(config, "text/html"),
          masks: [BS_MASK],
          delimStyle: "lang",
          innerStyle: "lang-bg",
        },
      )
    })

    var editor = CodeMirror.fromTextArea(document.getElementById("code"), {
      lineNumbers: true,
      mode: {
        name: 'pyx',
        identifiers: /^[_A-Za-z][_A-Za-z0-9]*/,
      },
      autoCloseBrackets: {
        override: true,
        pairs: `()[]{}''""$$§§\`\``,
        explode: `()[]{}`,
      },
      matchBrackets: true,
      tabMode: 'spaces',
      extraKeys: {
        "Ctrl-Space": "autocomplete",
      },
    });
  </script>

  <p>Demonstration of mode nesting for complex requirements.</p>
  <p>The main mode is the python mode.</p>
  <p>Extended Features:</p>
  <ul>
    <li>
      syntax extension for references in the pattern: <code>$ref.path$[optional;getitem]</code>.
      The components are realized as own sub mode definitions and in conjunction with the <code>suffixes: &lt;Array[&lt;SubModeConfig&gt;, ...]&gt;</code> configuration.
    </li>
    <li>
      active masks to avoid confusion for:
      <ul>
        <li>string literals</li>
        <li>backslash escape</li>
        <li>comments</li>
      </ul>
    </li>
    <li>special f-string literal mode for recursive nesting</li>
    <li>htmlmixed mode in a sub mode configuration</li>
  </ul>
  
</article>
